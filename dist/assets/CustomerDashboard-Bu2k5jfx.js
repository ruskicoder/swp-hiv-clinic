import{u as J,a as K,r as n,j as e,d as o,E as u}from"./index-ottAEAuo.js";import{D as Q}from"./DashboardHeader-BBOE_SHF.js";import{P as X,U as Z,c as _,v as ee}from"./UnifiedCalendar-C8K6WHrd.js";import{s as t,a as g,b as k}from"./renderUtils-BkDR37Se.js";import"./UserProfileDropdown-Cl9Ss_zV.js";import"./SafeComponents-D2JEnfCK.js";const ce=()=>{const{user:N,logout:S}=J(),A=K(),[d,l]=n.useState("overview"),[b,c]=n.useState(!1),[i,h]=n.useState(""),[x,E]=n.useState([]),[v,C]=n.useState([]),[R,T]=n.useState(null),[f,B]=n.useState([]),[m,P]=n.useState(null),[F,U]=n.useState([]),p=async()=>{try{c(!0),h("");const[s,a]=await Promise.all([o.get("/appointments/patient/my-appointments"),o.get("/doctors")]);E(s.data||[]),C(a.data||[])}catch(s){console.error("Error loading dashboard data:",s),h("Failed to load dashboard data. Please try again.")}finally{c(!1)}},y=async()=>{try{const s=await o.get("/patient-records/my-record");T(s.data)}catch(s){console.error("Error loading patient record:",s)}},$=async()=>{try{const s=await o.get("/arv-treatments/my-treatments");B(s.data||[])}catch(s){console.error("Error loading ARV treatments:",s)}},I=async s=>{try{c(!0);const a=await o.get(`/doctors/${s}/available-slots`);U(a.data||[])}catch(a){console.error("Error loading doctor slots:",a),h("Failed to load doctor availability. Please try again.")}finally{c(!1)}},M=async s=>{P(s),l("booking"),await I(s.userId)},V=async s=>{if(!m||!s){h("Missing doctor or slot information");return}c(!0),h("");try{console.log("Booking slot with data:",s);const a=_(s,m.userId);console.log("Formatted booking data:",a);const r=ee(a);if(!r.isValid)throw new Error(`Validation failed: ${r.errors.join(", ")}`);const j=await o.post("/appointments/book",a);if(j.data&&j.data.success!==!1)alert("Appointment booked successfully!"),l("appointments"),await p();else throw new Error(j.data?.message||"Failed to book appointment")}catch(a){console.error("Error booking appointment:",a);const r=a.response?.data?.message||a.message||"Failed to book appointment";h(r),alert(`Booking failed: ${r}`)}finally{c(!1)}},w=async(s,a="")=>{try{c(!0);const r=await o.put(`/appointments/${s}/cancel`,null,{params:{reason:a}});if(r.data&&r.data.success!==!1)alert("Appointment cancelled successfully!"),await p();else throw new Error(r.data?.message||"Failed to cancel appointment")}catch(r){console.error("Error cancelling appointment:",r);const j=r.response?.data?.message||r.message||"Failed to cancel appointment";h(j),alert(`Cancellation failed: ${j}`)}finally{c(!1)}},L=async s=>{try{const a=await o.put("/patient-records/my-record",s);if(a.data&&a.data.success!==!1)alert("Patient record updated successfully!"),await y();else throw new Error(a.data?.message||"Failed to update record")}catch(a){console.error("Error saving patient record:",a);const r=a.response?.data?.message||a.message||"Failed to save patient record";alert(`Save failed: ${r}`)}},O=async s=>{try{console.debug("Starting image upload with data:",{dataLength:s?.length,dataStart:s?.substring(0,50)+"..."});const a=await o.post("/patient-records/upload-image",{imageData:s});if(console.debug("Image upload response:",{success:a.data?.success,message:a.data?.message}),a.data?.success)return await y(),!0;throw new Error(a.data?.message||"Failed to upload image")}catch(a){throw console.error("Error uploading image:",{message:a.message,responseData:a.response?.data,status:a.response?.status}),new Error(a.response?.data?.message||a.message||"Failed to upload image")}},H=()=>{S(),A("/")};n.useEffect(()=>{p(),d==="record"&&(y(),$())},[d]);const D=()=>e.jsx(u,{children:e.jsxs("div",{className:"overview-content",children:[e.jsxs("div",{className:"content-header",children:[e.jsx("h2",{children:"Dashboard Overview"}),e.jsxs("p",{children:["Welcome back, ",t(N?.username),"!"]})]}),e.jsxs("div",{className:"stats-grid",children:[e.jsxs("div",{className:"stat-card",children:[e.jsx("h3",{children:"Total Appointments"}),e.jsx("p",{className:"stat-number",children:x?.length||0})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("h3",{children:"Upcoming Appointments"}),e.jsx("p",{className:"stat-number",children:x?.filter(s=>s.status==="Scheduled"&&new Date(s.appointmentDateTime)>new Date).length||0})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("h3",{children:"Available Doctors"}),e.jsx("p",{className:"stat-number",children:v?.length||0})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("h3",{children:"ARV Treatments"}),e.jsx("p",{className:"stat-number",children:f?.length||0})]})]}),i&&e.jsxs("div",{className:"error-message",children:[i,e.jsx("button",{onClick:p,className:"refresh-btn",children:"Retry"})]}),e.jsxs("div",{className:"recent-appointments",children:[e.jsx("h3",{children:"Recent Appointments"}),x?.slice(0,3).map(s=>e.jsxs("div",{className:"appointment-card",children:[e.jsxs("div",{className:"appointment-header",children:[e.jsxs("h4",{children:["Dr. ",t(s.doctorUser?.firstName)," ",t(s.doctorUser?.lastName)]}),e.jsx("span",{className:`status ${s.status?.toLowerCase()}`,children:t(s.status)})]}),e.jsxs("div",{className:"appointment-details",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Date:"})," ",g(s.appointmentDateTime)]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Time:"})," ",k(s.appointmentDateTime)]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Specialty:"})," ",t(s.doctorUser?.specialty)]})]})]},s.appointmentId))]})]})}),W=()=>e.jsx(u,{children:e.jsxs("div",{className:"appointments-content",children:[e.jsxs("div",{className:"content-header",children:[e.jsx("h2",{children:"My Appointments"}),e.jsx("p",{children:"View and manage your appointments"})]}),i&&e.jsxs("div",{className:"error-message",children:[i,e.jsx("button",{onClick:p,className:"refresh-btn",children:"Retry"})]}),e.jsx("div",{className:"appointments-list",children:x?.length===0?e.jsxs("div",{className:"no-data",children:[e.jsx("p",{children:"No appointments found."}),e.jsx("button",{onClick:()=>l("doctors"),className:"book-btn",children:"Book Your First Appointment"})]}):x.map(s=>e.jsxs("div",{className:"appointment-card",children:[e.jsxs("div",{className:"appointment-header",children:[e.jsxs("h4",{children:["Dr. ",t(s.doctorUser?.firstName)," ",t(s.doctorUser?.lastName)]}),e.jsx("span",{className:`status ${s.status?.toLowerCase()}`,children:t(s.status)})]}),e.jsxs("div",{className:"appointment-details",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Date:"})," ",g(s.appointmentDateTime)]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Time:"})," ",k(s.appointmentDateTime)]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Duration:"})," ",s.durationMinutes||30," minutes"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Specialty:"})," ",t(s.doctorUser?.specialty)]}),s.appointmentNotes&&e.jsxs("p",{children:[e.jsx("strong",{children:"Notes:"})," ",t(s.appointmentNotes)]})]}),e.jsx("div",{className:"appointment-actions",children:s.status==="Scheduled"&&new Date(s.appointmentDateTime)>new Date&&e.jsx("button",{onClick:()=>{const a=prompt("Please provide a reason for cancellation (optional):");a!==null&&w(s.appointmentId,a)},className:"cancel-btn",disabled:b,children:"Cancel Appointment"})})]},s.appointmentId))})]})}),Y=()=>e.jsx(u,{children:e.jsxs("div",{className:"doctors-content",children:[e.jsxs("div",{className:"content-header",children:[e.jsx("h2",{children:"Available Doctors"}),e.jsx("p",{children:"Choose a doctor to book an appointment"})]}),i&&e.jsxs("div",{className:"error-message",children:[i,e.jsx("button",{onClick:p,className:"refresh-btn",children:"Retry"})]}),e.jsx("div",{className:"doctors-grid",children:v?.length===0?e.jsxs("div",{className:"no-data",children:[e.jsx("p",{children:"No doctors available at the moment."}),e.jsx("button",{onClick:p,className:"refresh-btn",children:"Refresh"})]}):v.map(s=>e.jsxs("div",{className:"doctor-card",children:[e.jsxs("h4",{children:["Dr. ",t(s.firstName)," ",t(s.lastName)]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Specialty:"})," ",t(s.specialty)]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Email:"})," ",t(s.email)]}),e.jsx("button",{onClick:()=>M(s),className:"book-btn",disabled:b,children:"Book Appointment"})]},s.userId))})]})}),q=()=>e.jsx(u,{children:e.jsxs("div",{className:"book-appointment-content",children:[e.jsxs("div",{className:"content-header",children:[e.jsx("h2",{children:"Book Appointment"}),m&&e.jsxs("p",{children:["Booking with Dr. ",t(m.firstName)," ",t(m.lastName)]})]}),i&&e.jsx("div",{className:"error-message",children:i}),m&&e.jsx(Z,{slots:F,userRole:"patient",currentUserId:N?.userId,doctorInfo:m,onBookSlot:V,onCancelBooking:w})]})}),z=()=>e.jsx(u,{children:e.jsxs("div",{className:"record-content",children:[e.jsxs("div",{className:"content-header",style:{width:"100%"},children:[e.jsx("h2",{children:"My Medical Record"}),e.jsx("p",{children:"View and update your medical information"})]}),e.jsxs("div",{className:"record-main",children:[e.jsx(X,{record:R,onSave:L,onImageUpload:O,isEditable:!0}),f?.length>0&&e.jsxs("div",{className:"arv-treatments-section",children:[e.jsx("h3",{children:"ARV Treatment History"}),e.jsx("div",{className:"treatments-list",children:f.map(s=>e.jsxs("div",{className:"treatment-card",children:[e.jsx("h4",{children:t(s.regimen)}),e.jsxs("p",{children:[e.jsx("strong",{children:"Start Date:"})," ",g(s.startDate)]}),s.endDate&&e.jsxs("p",{children:[e.jsx("strong",{children:"End Date:"})," ",g(s.endDate)]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Adherence:"})," ",t(s.adherence)]}),s.notes&&e.jsxs("p",{children:[e.jsx("strong",{children:"Notes:"})," ",t(s.notes)]})]},s.arvTreatmentId))})]})]})]})}),G=()=>{if(b&&!x.length&&!v.length)return e.jsx("div",{className:"loading",children:e.jsx("p",{children:"Loading dashboard..."})});switch(d){case"overview":return D();case"appointments":return W();case"doctors":return Y();case"booking":return q();case"record":return z();default:return D()}};return e.jsxs("div",{className:"customer-dashboard",children:[e.jsx(Q,{user:N,onLogout:H,title:"Patient Dashboard"}),e.jsxs("div",{className:"dashboard-layout",children:[e.jsxs("div",{className:"dashboard-sidebar",children:[e.jsxs("div",{className:"sidebar-header",children:[e.jsx("h1",{children:"Patient Portal"}),e.jsx("p",{children:"Manage your healthcare"})]}),e.jsxs("nav",{className:"dashboard-nav",children:[e.jsx("div",{className:"nav-item",children:e.jsxs("button",{className:`nav-button ${d==="overview"?"active":""}`,onClick:()=>l("overview"),children:[e.jsx("span",{className:"nav-icon",children:"📊"}),"Overview"]})}),e.jsx("div",{className:"nav-item",children:e.jsxs("button",{className:`nav-button ${d==="appointments"?"active":""}`,onClick:()=>l("appointments"),children:[e.jsx("span",{className:"nav-icon",children:"📅"}),"My Appointments"]})}),e.jsx("div",{className:"nav-item",children:e.jsxs("button",{className:`nav-button ${d==="doctors"?"active":""}`,onClick:()=>l("doctors"),children:[e.jsx("span",{className:"nav-icon",children:"👨‍⚕️"}),"Find Doctors"]})}),e.jsx("div",{className:"nav-item",children:e.jsxs("button",{className:`nav-button ${d==="record"?"active":""}`,onClick:()=>l("record"),children:[e.jsx("span",{className:"nav-icon",children:"📋"}),"Medical Record"]})})]})]}),e.jsx("div",{className:"dashboard-main",children:e.jsx("div",{className:"dashboard-content",children:G()})})]})]})};export{ce as default};
